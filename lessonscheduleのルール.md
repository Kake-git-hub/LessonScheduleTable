# 授業スケジュール割り当てルール

## 概要

本ドキュメントでは、授業スケジュール自動割り当てシステムにおける、コマ割り当ての基本ルールとスコアリングロジックを定義します。

## 基本構成

- **1コマの構成**: 先生1人 + 生徒1〜2人 = 1コマ
- 生徒が1人の場合: 個別指導
- 生徒が2人の場合: グループ授業

## ハード制約（必須ルール）

以下の条件をすべて満たす場合のみ、割り当てが可能です。

1. **出席可能性**: 先生と生徒の両方が、そのコマに出席可能（availability が true）であること
2. **科目の一致**: 先生の担当科目と生徒の受講科目に共通科目があること
3. **incompatible 制約**: `incompatible`（組み合わせ不可）に設定された先生×生徒ペアは割り当てない
4. **生徒数の上限**: 1コマあたりの生徒数は最大2人まで
5. **先生の二重割り当て防止**: 同じスロットに同じ先生を二重割り当てしない
6. **生徒の二重割り当て防止**: 同じスロットに同じ生徒を二重割り当てしない

## ソフト制約（スコアリングルール）

各割り当て候補のスコアは以下の要素で構成されます:

### スコア計算式

```
score = 100 + (推奨ペア数 × 30) + (2人グループなら5) - (先生既割当数 × 6) - (生徒既割当数合計 × 8)
```

### 詳細

1. **ベーススコア**: 100点
   - すべての割り当て候補の基準点

2. **推奨ペアボーナス**: +30点/ペア
   - `recommended`（推奨）制約が設定された先生×生徒ペアに対して加算
   - グループ授業の場合、各生徒について独立に評価

3. **グループ授業ボーナス**: +5点
   - 生徒が2人の場合に加算
   - グループ学習の促進を目的とする

4. **先生の負荷均等化ペナルティ**: -6点 × 先生の既割当コマ数
   - 特定の先生に授業が集中しないよう、既に多くのコマを持つ先生の優先度を下げる

5. **生徒の負荷均等化ペナルティ**: -8点 × 各生徒の既割当コマ数の合計
   - 特定の生徒に授業が集中しないよう、既に多くのコマを持つ生徒の優先度を下げる
   - グループ授業の場合、両生徒の既割当コマ数を合算してペナルティを算出

## 割り当てアルゴリズム

### グリーディ法による最適化

システムは以下の手順で自動割り当てを実行します:

1. **スロット順処理**: 各タイムスロットを順番に処理
2. **候補の生成**: そのスロットで利用可能な先生と生徒の組み合わせを生成
   - 先生ごとに、出席可能な生徒を抽出
   - 生徒1人の組み合わせと、生徒2人の組み合わせを生成
3. **ハード制約のチェック**: 上記のハード制約をすべて満たす組み合わせのみを候補とする
4. **スコア計算**: 各候補について上記のスコアリングルールに基づきスコアを算出
5. **最良候補の選択**: そのスロットで最もスコアの高い組み合わせを割り当て
6. **次スロットへ**: 次のスロットに進み、同様の処理を繰り返す

### 特徴

- **局所最適化**: 各スロットで最良の選択を行うグリーディアルゴリズム
- **負荷分散**: 既割当数を考慮することで、先生と生徒の負荷を均等化
- **優先度の反映**: 推奨ペアを優先的に割り当て

## 実装

本ルールは `src/App.tsx` の `buildAutoAssignments` 関数で実装されています。

## 備考

- スコアリングの各係数（ベーススコア100、推奨+30、グループ+5、先生ペナルティ-6、生徒ペナルティ-8）は、実運用での最適なバランスを考慮して設定されています
- アルゴリズムの性質上、全体最適解を保証するものではありませんが、計算効率と実用性のバランスを重視しています
