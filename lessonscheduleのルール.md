# 授業割り当てシステムのルール

このドキュメントでは、授業割り当てシステムで適用される主要なルールについて説明します。

## 1. 提出データ

### 先生
- **出席可能日（availability）**: 先生は出席可能なスロット（日付と時限の組み合わせ）のリストを提出します。

### 生徒
生徒は以下の情報を提出します：

- **希望科目**: 受講したい科目のリスト
- **希望科目ごとの総希望コマ数**: 各科目について何コマ受講したいかを指定します。「コマ」とは1つの授業枠を意味します。
  - 例: `{ "数学": 5, "英語": 3 }` - 数学を5コマ、英語を3コマ希望
- **出席不可能日**: 出席できない日のリスト（YYYY-MM-DD形式）。出席不可能日以外のスロットは全て出席可能と見なされます。

## 2. 通常授業と特別講習

### 通常授業（regular）
- 通常の授業データを取り込めるようにする。
- 通常授業は既に曜日・時限が決まっている固定の授業。
- 通常授業は該当する曜日と時限のスロットに**最優先**で割り当てられます。

### 特別講習（special）
- 現在のシステムで扱っている講習期間中のコマ割り。
- 通常授業の割り当て後、残りのスロットに対して自動割り当てを行います。
- 通常授業が入っているスロットには特別講習を割り当てません。

## 3. 割り振り優先順

- **生徒のデータ提出順番**（`students` 配列でのインデックス順）をそのまま割り振り優先順とします。
- 先に提出した生徒（配列の先頭に近い生徒）が優先的にコマを割り当てられます。
- スコアリングの際、配列の先頭に近い生徒ほど優先ボーナスが付与されます（最大20ポイント、生徒インデックスごとに2ポイント減少）。

## 4. 科目ごとの希望コマ数

- 各生徒は科目ごとに希望するコマ数を指定します。
- 希望コマ数に達した科目については、それ以上割り当てを行いません。
- 希望コマ数が未充足の生徒を優先します（充足率が低いほどボーナスポイントが付与されます）。

## 5. スコアリングシステム

自動割り当ては以下のスコアリングに基づいて最適な組み合わせを選択します：

### 基本スコア
- **ベーススコア**: 100ポイント

### ボーナス
- **推奨ペア**: +30ポイント（生徒1人あたり）
- **グループボーナス**: +5ポイント（生徒2人の場合）
- **優先順位ボーナス**: 最大+20ポイント（提出順が早い生徒ほど高いボーナス）
- **未充足ボーナス**: 最大+10ポイント（希望コマ数の充足率が低い生徒ほど高いボーナス）

### ペナルティ
- **先生の負担**: -6ポイント × 既に割り当てられているコマ数
- **生徒の負担**: -8ポイント × 既に割り当てられているコマ数（生徒1人あたり）

## 6. 制約条件

### 必須条件
- 先生と生徒の両方がそのスロットで出席可能であること
- 生徒の出席不可能日に該当しないこと
- 組み合わせ不可（incompatible）に設定されていないこと
- 共通の科目が存在すること
- その科目の希望コマ数に達していないこと

### 推奨条件
- 組み合わせ推奨（recommended）のペアを優先
- 負担の偏りを軽減（先生・生徒の既存の割り当て数を考慮）
- グループ授業（生徒2人）を軽く優遇

## 7. 自動割り当ての流れ

1. **通常授業の割り当て**: 各スロットについて、該当する曜日・時限の通常授業があれば最優先で割り当て
2. **特別講習の割り当て**: 残りのスロットについて以下を実行
   - 出席可能な先生を抽出
   - 各先生について、条件を満たす生徒候補を抽出
   - 1人または2人の生徒の組み合わせを生成
   - 共通科目と希望コマ数をチェック
   - スコアを計算し、最高スコアの組み合わせを選択
   - そのスロットに割り当て

## 8. 運用の流れ

1. 管理画面で講習期間、科目、先生、生徒を登録
2. 通常授業がある場合は「通常授業管理」セクションで登録
3. 先生と生徒にURLを配布し、出席可能日/不可能日を入力してもらう
4. 生徒は希望科目と科目ごとの希望コマ数も登録
5. 制約（組み合わせ不可・推奨）を設定
6. 「自動提案」ボタンで割り当てを実行
7. 手動で微調整が可能
