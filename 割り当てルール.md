# コマ割り 割り当てルール

## 概要

コマ割りには **通常授業** と **特別講習** の2種類があり、別々のルールで管理されます。

---

## 1. 通常授業

### 定義
- マスターデータの「通常授業管理」で登録された、曜日・時限固定の授業。
- 先生 + 生徒（1〜2名）+ 科目 + 曜日 + 時限 の組み合わせ。

### 自動配置ルール
- **日付確定時に自動配置**: セッションの開始日・終了日が設定されると、該当する曜日・時限のスロットに通常授業が自動的に割り当てられる。
- 通常授業のスロットは **青枠＋「通常授業」バッジ** で視覚的に区別される。
- 手動で上書きされた（非通常授業の）割当がある場合、自動配置は行わない。
- 通常授業はマスターデータの変更に連動して自動更新される。

### 自動提案との関係
- 自動提案実行時、通常授業スロットは変更されない（保護される）。
- 通常授業スロットの生徒追加・先生差替は行わない。

---

## 2. 特別講習（自動提案）

### 割当条件
以下の **すべて** を満たす場合に割当可能：

1. **先生が希望を出している**: 先生がそのスロットに出勤可能と入力済み
2. **生徒が出席可能**: 生徒がそのスロットの日付を「出席不可」にしていない
3. **生徒が入力済み**: 未入力（`submittedAt = 0`）の生徒はすべて出席不可として扱う
4. **制約ルールで不可でない**: ペア制約・学年制約で `incompatible` でない
5. **生徒の希望コマ数が残っている**: 該当科目の希望コマ数 > 割当済コマ数
6. **先生と生徒で共通科目がある**: 先生の担当科目と生徒の受講科目に共通科目が存在

### スコアリング（優先順位）

自動提案は以下のスコアに基づいて最適な割当を選択します：

| 要素 | スコア | 説明 |
|---|---|---|
| 基本点 | +100 | ベーススコア |
| **既存出勤日の再利用** | **+80** | 先生がその日に既に割当がある場合（出勤日数最小化・最優先） |
| **新規出勤日ペナルティ** | **-50** | 先生がその日にまだ割当がない場合 |
| **講師連続コマボーナス** | **+20** | 先生がその日の隣接コマに既に割当がある場合 |
| **前半バイアス** | **+0〜+25** | 期間前半の日付を優先（最初の日=+25、最後の日=0） |
| 推奨ペア | +30/人 | ペア制約で `recommended` の場合 |
| **2人ペア** | **+30** | 生徒2人のペアの場合（ペア効率を強く優先） |
| **生徒同日複数コマ回避** | **-60** | 生徒がその日に既にコマがある場合（通常授業含む） |
| **生徒連続コマボーナス** | **+50** | 同日複数コマになる場合、連続コマであれば強く加算 |
| **生徒非連続コマペナルティ** | **-30** | 同日複数コマで非連続の場合、追加ペナルティ |
| **生徒残コマ数** | **+10×残数** | 残コマが多い生徒ほど優先される |
| **生徒日数分散** | **-5×既割当日数** | 割当済み日数が少ない生徒を優先 |
| **希望時限ボーナス** | **+15** | 生徒が希望した時限に配置する場合 |
| 先生負荷 | -2/コマ | 先生の既存割当コマ数に比例 |
| 生徒負荷 | -8/コマ/人 | 生徒の既存割当コマ数に比例 |

### 同一生徒連続コマ回避（講師視点）

- 同じ講師の連続コマに **同一の生徒** が配置されることを回避する
- 講師の前のコマに割り当てられた生徒は、次のコマの候補から自動的に除外される

### 最適化の方針

1. **先生全数の出勤日数を最小化（最優先）**: 同じ先生はなるべく少ない日数に集約する（+80 / -50 のスコア差）
2. **講師連続コマの優先**: 同じ先生を連続コマに割り当てることを優先（+20）。ただし同一生徒が連続コマになることは避ける
3. **前半バイアス**: 期間の前半に偏るように割り振る（最大+25）
4. **2人ペアを積極的に活用**: 効率ボーナス +30 により、1人割当より2人ペアを強く優先
5. **推奨ペアを優先**: 制約で推奨されている先生×生徒の組み合わせを優先する（+30）
6. **生徒の出席日分散**: 出席可能日に均等に分散し、同日複数コマは避ける（-60）。やむを得ない場合は極力連続コマとする（連続+50 / 非連続-30）
7. **生徒の残コマが多い生徒を優先**: 残コマ数が多い生徒ほど先に割当てる
8. **生徒の希望時限を尊重**: 生徒が入力した希望時限にマッチするスロットを優先（+15）

### 処理フェーズ

#### Phase 1: クリーンアップ
- 削除された先生・生徒を含む既存割当を整理
- 通常授業の割当はスキップ（変更しない）
- 削除された先生は代替を探す。見つからなければ割当解除
- 削除された生徒はリストから除外

#### Phase 2: 既存割当の補完
- 既に一部割当されているスロット（非通常授業）の空き生徒ポジションを埋める
- 残コマ数が最も多い生徒を優先

#### Phase 3: 新規割当
- 各スロットに対して、スコアリングに基づいて最適な先生×生徒ペアを割当
- **同日同時限に複数ペアを割当可能**（別々の先生がそれぞれ生徒を担当）
- 既存割当があるスロットにも追加ペアを割当できる（通常授業のみのスロットは保護）
- 先生は **その日に既に出勤している先生を優先** してソート
- 各先生について最適な生徒の組み合わせ（1人 or 2人）と科目を選択

---

## 3. 手動操作

- コマ割りグリッド上で手動での割当変更が可能
- 制約不可の組み合わせでも警告付きで手動割当可
- 通常授業スロットも手動で上書き可能（上書き後は自動配置の対象外になる）

---

## 4. 生徒の可用性ルール

| 状態 | 扱い |
|---|---|
| 未入力（`submittedAt = 0`） | すべての日で **出席不可** |
| 入力済み + 不可日に含まれない日 | **出席可能** |
| 入力済み + 不可日に含まれる日 | **出席不可** |

---

## 5. 先生の可用性ルール

- 先生が希望を出した（availability に登録された）スロットのみ割当対象
- 希望を出していないスロットではドロップダウンにも表示されない

---

## 6. 生徒の希望時限

### 概要
- 生徒希望フォームで **希望時限** を入力可能（時限番号のボタン選択）。
- 日付に依存しない共通の希望時限（例: 1限, 3限）を選択する。
- `preferredSlots` フィールドに `["1", "3"]` のように時限番号の文字列配列として保存。

### 自動提案への反映
- 希望時限にマッチするスロット番号に配置すると **+15** のスコアボーナス。
- 必須条件ではなく「優先」として扱う（他の条件と合わせて最適化）。

---

## 7. Excel出力

### 概要
- コマ割りページからExcelファイルを出力可能。
- **週単位でシート分割**: 月曜～日曜の1週間を1シートとして出力。
- **A3縦印刷対応**: 7日分の列 + 時限ラベル列でA3縦に収まるレイアウト。
- 各セルの内容は改行で区切り:
  - 通常授業: `[通常]` + 改行 + 先生名 + 改行 + 生徒名(各行) + 改行 + (科目)
  - 複数ペアは `---` で区切り
- 休日列は `///` 表示。
