# コマ割り 割り当てルール

## 概要

コマ割りには **通常授業** と **特別講習** の2種類があり、別々のルールで管理されます。

---

## 1. 通常授業

### 定義
- マスターデータの「通常授業管理」で登録された、曜日・時限固定の授業。
- 先生 + 生徒（1〜2名）+ 科目 + 曜日 + 時限 の組み合わせ。

### 自動配置ルール
- **日付確定時に自動配置**: セッションの開始日・終了日が設定されると、該当する曜日・時限のスロットに通常授業が自動的に割り当てられる。
- 通常授業のスロットは **青枠＋「通常授業」バッジ** で視覚的に区別される。
- 手動で上書きされた（非通常授業の）割当がある場合、自動配置は行わない。
- 通常授業はマスターデータの変更に連動して自動更新される。

### 自動提案との関係
- 自動提案実行時、通常授業スロットは変更されない（保護される）。
- 通常授業スロットの生徒追加・先生差替は行わない。

---

## 2. 特別講習（自動提案）

### 割当条件
以下の **すべて** を満たす場合に割当可能：

1. **先生が希望を出している**: 先生がそのスロットに出勤可能と入力済み
2. **生徒が出席可能**: 生徒がそのスロットの日付を「出席不可」にしていない
3. **生徒が入力済み**: 未入力（`submittedAt = 0`）の生徒はすべて出席不可として扱う
4. **制約ルールで不可でない**: ペア制約・学年制約で `incompatible` でない
5. **生徒の希望コマ数が残っている**: 該当科目の希望コマ数 > 割当済コマ数
6. **先生と生徒で共通科目がある**: 先生の担当科目と生徒の受講科目に共通科目が存在

### スコアリング（優先順位）

自動提案は以下のスコアに基づいて最適な割当を選択します：

| 要素 | スコア | 説明 |
|---|---|---|
| 基本点 | +100 | ベーススコア |
| **既存出勤日の再利用** | **+50** | 先生がその日に既に割当がある場合（出勤日数最小化） |
| **同日同科目グルーピング** | **+20** | 先生がその日に既に同じ科目を教えている場合 |
| 推奨ペア | +30/人 | ペア制約で `recommended` の場合 |
| 2人ペア | +5 | 生徒2人のペアの場合（効率ボーナス） |
| 新規出勤日ペナルティ | -30 | 先生がその日にまだ割当がない場合 |
| 先生負荷 | -2/コマ | 先生の既存割当コマ数に比例 |
| 生徒負荷 | -8/コマ/人 | 生徒の既存割当コマ数に比例 |

### 最適化の方針

1. **先生の出勤日数を最小化**: 同じ先生はなるべく少ない日数に集約する（+50 / -30 のスコア差）
2. **同日の科目をそろえる**: 同じ日に同じ科目を教えるよう優先する（+20）
3. **推奨ペアを優先**: 制約で推奨されている先生×生徒の組み合わせを優先する（+30）
4. **生徒の残コマが多い生徒を優先**: 残コマ数が多い生徒ほど先に割当てる

### 処理フェーズ

#### Phase 1: クリーンアップ
- 削除された先生・生徒を含む既存割当を整理
- 通常授業の割当はスキップ（変更しない）
- 削除された先生は代替を探す。見つからなければ割当解除
- 削除された生徒はリストから除外

#### Phase 2: 既存割当の補完
- 既に一部割当されているスロット（非通常授業）の空き生徒ポジションを埋める
- 残コマ数が最も多い生徒を優先

#### Phase 3: 新規割当
- 空きスロットに対して、スコアリングに基づいて最適な先生×生徒ペアを割当
- 先生は **その日に既に出勤している先生を優先** してソート
- 各先生について最適な生徒の組み合わせ（1人 or 2人）と科目を選択

---

## 3. 手動操作

- コマ割りグリッド上で手動での割当変更が可能
- 制約不可の組み合わせでも警告付きで手動割当可
- 通常授業スロットも手動で上書き可能（上書き後は自動配置の対象外になる）

---

## 4. 生徒の可用性ルール

| 状態 | 扱い |
|---|---|
| 未入力（`submittedAt = 0`） | すべての日で **出席不可** |
| 入力済み + 不可日に含まれない日 | **出席可能** |
| 入力済み + 不可日に含まれる日 | **出席不可** |

---

## 5. 先生の可用性ルール

- 先生が希望を出した（availability に登録された）スロットのみ割当対象
- 希望を出していないスロットではドロップダウンにも表示されない
